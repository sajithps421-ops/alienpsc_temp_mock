<!DOCTYPE html>
<html>
<head>
  <title>Mock Exam</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="temp_style.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<div class="card" id="questionBox">

  <!-- TOP BAR -->
  <div class="top">
    <div id="qCount">Question 1</div>

    <div style="display:flex; gap:8px; align-items:center;">
      <button class="small-btn" onclick="toggleLang()">üåê EN / ML</button>
      <button class="small-btn" id="timerBox">‚è± 00:00</button>
      <button class="small-btn" onclick="exitExam()">Exit</button>
    </div>
  </div>

  <!-- PROGRESS BAR -->
  <div style="width:100%; background:#e2e8f0; height:8px; border-radius:10px; margin:10px 0;">
    <div id="progressBar" style="height:8px; width:100%; background:#22c55e; border-radius:10px;"></div>
  </div>

  <h3 id="qText">Loading...</h3>
  <div id="options"></div>

  <br>
  <button onclick="prevQ()">Previous</button>
  <button onclick="nextQ()">Next</button>
  <button onclick="submitExam()">Submit</button>

</div>

<script>

/* ---------- SUPABASE ---------- */
const SUPABASE_URL = "https://jnnrphexgnqfrguuvpcw.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_eqpEBptiUc85ICVGIx65vA_nZfQg9-l"; // üî• Replace with real key
const supabaseClient = window.supabase.createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY
);

/* ---------- VARIABLES ---------- */
let questions = [];
let currentIndex = 0;
let answers = {};
let lang = "en";
let examSubmitted = false;

const mockId = parseInt(localStorage.getItem("mock_id"));
const userName = localStorage.getItem("temp_name");

/* ---------- TIMER ---------- */
let timeLeft = 0;
let totalTime = 0;
let timerInterval;
let warningPlayed = false;

/* ---------- LOAD QUESTIONS ---------- */
async function loadQuestions() {

  if (!mockId || !userName) {
    alert("Session expired");
    window.location.href = "temp_login.html";
    return;
  }

  const { data, error } = await supabaseClient
    .from("temp_questions")
    .select("*")
    .eq("mock_id", mockId)
    .order("id", { ascending: true });

  if (error) {
    console.error(error);
    alert("Error loading questions");
    return;
  }

  questions = data || [];

  if (questions.length === 0) {
    document.getElementById("questionBox").innerHTML =
      "<h3>No Questions Found</h3>";
    return;
  }

  totalTime = questions.length * 45; // 45 sec per question
  timeLeft = totalTime;

  renderQuestion();
  startTimer();
}

/* ---------- TIMER ---------- */
function startTimer() {

  timerInterval = setInterval(() => {

    const minutes = Math.floor(timeLeft / 60);
    const seconds = timeLeft % 60;

    document.getElementById("timerBox").innerText =
      `‚è± ${minutes.toString().padStart(2,"0")}:${seconds.toString().padStart(2,"0")}`;

    const percentage = (timeLeft / totalTime) * 100;
    const progressBar = document.getElementById("progressBar");
    progressBar.style.width = percentage + "%";

    if (percentage <= 30) {
      progressBar.style.background = "#f59e0b";
    }

    if (timeLeft <= 10 && !warningPlayed) {
      warningPlayed = true;
      playWarning();
      progressBar.style.background = "#ef4444";
    }

    if (timeLeft <= 0) {
      clearInterval(timerInterval);
      submitExam();
    }

    timeLeft--;

  }, 1000);
}

/* ---------- WARNING SOUND ---------- */
function playWarning(){
  const audio = new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");
  audio.play();
}

/* ---------- RENDER ---------- */
function renderQuestion(){

  const q = questions[currentIndex];

  document.getElementById("qCount").innerText =
    `Question ${currentIndex+1} / ${questions.length}`;

  document.getElementById("qText").innerText =
    lang === "en" ? q.question_en : q.question_ml;

  const options = lang === "en" ? q.options_en : q.options_ml;
  const optDiv = document.getElementById("options");
  optDiv.innerHTML = "";

  options.forEach((opt,i)=>{
    const div = document.createElement("div");
    div.className = "option";
    div.innerText = opt;

    div.onclick = ()=>{
      answers[currentIndex] = i;
      renderQuestion();
    };

    if(answers[currentIndex] === i){
      div.classList.add("selected");
    }

    optDiv.appendChild(div);
  });
}

/* ---------- NAVIGATION ---------- */
function nextQ(){
  if(currentIndex < questions.length-1){
    currentIndex++;
    renderQuestion();
  }
}

function prevQ(){
  if(currentIndex > 0){
    currentIndex--;
    renderQuestion();
  }
}

/* ---------- LANGUAGE ---------- */
function toggleLang(){
  lang = lang === "en" ? "ml" : "en";
  renderQuestion();
}

/* ---------- SUBMIT ---------- */
async function submitExam(){

  if(examSubmitted) return; // prevent double submit
  examSubmitted = true;

  clearInterval(timerInterval);

  let score = 0;
  questions.forEach((q,i)=>{
    if(answers[i] === q.correct_index){
      score++;
    }
  });

  const timeUsed = totalTime - timeLeft;

  const { error } = await supabaseClient
    .from("temp_results")
    .insert([
      {
        user_name: userName,
        mock_id: mockId,
        score: score,
        total: questions.length,
        time_used: timeUsed
      }
    ]);

  if(error){
    console.error(error);
    alert("Error saving result");
    return;
  }

  localStorage.setItem("temp_score", score);
  localStorage.setItem("temp_total", questions.length);
  localStorage.setItem("temp_time_used", timeUsed);

  window.location.href = "temp_result.html";
}

/* ---------- EXIT ---------- */
function exitExam(){
  clearInterval(timerInterval);
  window.location.href = "temp_dashboard.html";
}

/* ---------- START ---------- */
loadQuestions();

</script>

</body>
</html>

<!DOCTYPE html>
<html>
<head>
  <title>Mock Result</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="temp_style.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<div class="card">

  <h2>ğŸ“Š Mock Result</h2>

  <div id="summary"></div>

  <div id="rankBox" style="margin-top:15px; font-weight:bold;"></div>

  <br>

  <button id="solutionBtn">ğŸ“˜ View Solutions</button>
  <button id="rankBtn">ğŸ† Leaderboard</button>
  <button id="dashBtn">â¬… Dashboard</button>

</div>

<script>

document.addEventListener("DOMContentLoaded", function(){

  const sb = window.supabase.createClient(
    "https://jnnrphexgnqfrguuvpcw.supabase.co",
    "sb_publishable_eqpEBptiUc85ICVGIx65vA_nZfQg9-l"
  );

  const userName = localStorage.getItem("temp_name");
  const mockIdRaw = localStorage.getItem("mock_id");

  if(!userName || !mockIdRaw){
    window.location.href = "temp_login.html";
    return;
  }

  const mockId = parseInt(mockIdRaw);

  function formatTime(seconds){
    const m = Math.floor(seconds/60);
    const s = seconds%60;
    return `${m.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`;
  }

  async function loadResult(){

    try {

      /* USER RESULT */
      const { data: userResult, error } = await sb
        .from("temp_results")
        .select("*")
        .eq("user_name", userName)
        .eq("mock_id", mockId)
        .single();

      if(error || !userResult){
        window.location.href = "temp_dashboard.html";
        return;
      }

      /* SAVE answers_json TO LOCAL STORAGE FOR REVIEW MODE */
      if(userResult.answers_json){
        localStorage.setItem("review_answers", JSON.stringify(userResult.answers_json));
      }

      /* LEADERBOARD */
      const { data: leaderboard } = await sb
        .from("temp_results")
        .select("*")
        .eq("mock_id", mockId)
        .order("score", { ascending:false })
        .order("time_used", { ascending:true });

      let rank = 0;
      leaderboard.forEach((item,index)=>{
        if(item.user_name === userName){
          rank = index + 1;
        }
      });

      document.getElementById("summary").innerHTML = `
        <p><strong>Name:</strong> ${userResult.user_name}</p>
        <p><strong>Score:</strong> ${userResult.score} / ${userResult.total}</p>
        <p><strong>Time Used:</strong> ${formatTime(userResult.time_used)}</p>
      `;

      document.getElementById("rankBox").innerHTML = `
        ğŸ¯ Your Rank: 
        <span style="color:#6366f1;">#${rank}</span> 
        out of ${leaderboard.length} participants
      `;

    } catch(err){
      console.error("Unexpected Error:", err);
    }
  }

  /* ---------- BUTTONS ---------- */

  document.getElementById("solutionBtn").addEventListener("click", function(){
    localStorage.setItem("review_mode", "true");
    window.location.href = "temp_exam.html";
  });

  document.getElementById("rankBtn").addEventListener("click", function(){
    window.location.href = "temp_rank.html";
  });

  document.getElementById("dashBtn").addEventListener("click", function(){
    window.location.href = "temp_dashboard.html";
  });

  loadResult();

});

</script>

</body>
</html>

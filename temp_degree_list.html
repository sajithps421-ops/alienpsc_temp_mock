<!DOCTYPE html>
<html>
<head>
  <title>Mock Tests</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="temp_style.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<div class="card">
  <h2 id="pageTitle">Mock Tests</h2>

  <div class="option" onclick="startExam(1)">Mock Test 1</div>
  <div class="option" onclick="startExam(2)">Mock Test 2</div>
  <div class="option" onclick="startExam(3)">Mock Test 3</div>

  <br>
  <button onclick="goBack()">â¬… Back</button>
</div>

<script>

/* ===========================
   SUPABASE
===========================*/
const supabaseClient = window.supabase.createClient(
  "https://jnnrphexgnqfrguuvpcw.supabase.co",
  "sb_publishable_eqpEBptiUc85ICVGIx65vA_nZfQg9-l"
);

/* ===========================
   SESSION CHECK
===========================*/
const userName = localStorage.getItem("temp_name");
const LEVEL = localStorage.getItem("mock_level");

if(!userName){
  alert("Session expired. Login again.");
  window.location.replace("temp_login.html");
}

if(!LEVEL){
  alert("Level not selected. Please select level again.");
  window.location.replace("temp_dashboard.html");
}

/* ===========================
   DYNAMIC TITLE
===========================*/
document.getElementById("pageTitle").innerText =
  LEVEL === "degree"
  ? "ðŸŽ“ Degree Level Mock Tests"
  : "ðŸ« 10th & LGS Level Mock Tests";


/* ===========================
   START EXAM
===========================*/
async function startExam(mockNumber){

  try{

    /* SAVE SESSION */
    localStorage.setItem("mock_number", mockNumber);

    console.log("SESSION:", LEVEL, mockNumber);

    /* CHECK ATTEMPT */
    const { data, error } = await supabaseClient
      .from("temp_results")
      .select("id")
      .eq("user_name", userName)
      .eq("level", LEVEL)
      .eq("mock_number", mockNumber);

    if(error){
      console.error(error);
      alert("Error checking attempt");
      return;
    }

    /* ALREADY ATTEMPTED */
    if(data.length > 0){

      localStorage.setItem("exam_locked","true");
      localStorage.removeItem("review_mode");

      window.location.href = "temp_result.html";
      return;
    }

    /* ALLOW EXAM */
    localStorage.setItem("exam_locked","false");
    localStorage.removeItem("review_mode");

    window.location.href = "temp_exam.html";

  }catch(err){
    console.error(err);
    alert("Something went wrong");
  }
}

/* ===========================
   BACK
===========================*/
function goBack(){
  window.location.href = "temp_dashboard.html";
}

</script>

</body>
</html>

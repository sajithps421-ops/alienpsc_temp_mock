<!DOCTYPE html>
<html>
<head>
  <title>Mock Exam</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="temp_style.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>

<div class="card" id="questionBox">

  <div class="top">
    <div id="qCount">Question 1</div>

    <div style="display:flex; gap:8px; align-items:center;">
      <button class="small-btn" id="langBtn" onclick="toggleLang()">üåê EN / ML</button>
      <button class="small-btn" id="timerBox">‚è± 00:00</button>
      <button class="small-btn" onclick="exitExam()">Exit</button>
    </div>
  </div>

  <div style="width:100%; background:#e2e8f0; height:8px; border-radius:10px; margin:10px 0;">
    <div id="progressBar" style="height:8px; width:100%; background:#22c55e;"></div>
  </div>

  <h3 id="qText">Loading...</h3>
  <div id="options"></div>
  <div id="explanationBox" style="margin-top:12px; font-size:14px;"></div>

  <br>
  <button onclick="prevQ()">Previous</button>
  <button onclick="nextQ()">Next</button>
  <button id="submitBtn" onclick="submitExam()">Submit</button>

</div>

<script>

/* =====================================================
   SUPABASE
===================================================== */
const supabaseClient = window.supabase.createClient(
  "https://jnnrphexgnqfrguuvpcw.supabase.co",
  "sb_publishable_eqpEBptiUc85ICVGIx65vA_nZfQg9-l"
);

/* =====================================================
   SESSION SAFE LOAD
===================================================== */
const userName   = localStorage.getItem("temp_name");
const level      = localStorage.getItem("mock_level");
const mockNumber = parseInt(localStorage.getItem("mock_number"));
const reviewMode = localStorage.getItem("review_mode") === "true";

if(!userName){
  alert("Session expired. Login again.");
  location.replace("temp_login.html");
}

if(!level || isNaN(mockNumber)){
  alert("Mock not selected. Please choose a mock test.");
  location.replace("temp_dashboard.html");
}

/* =====================================================
   VARIABLES
===================================================== */
let questions = [];
let currentIndex = 0;
let answers = {};
let lang = "en";
let examSubmitted = false;

/* =====================================================
   FORCE MALAYALAM FOR 10TH LEVEL
===================================================== */
if(level === "10th"){
  lang = "ml";
  document.getElementById("langBtn").style.display = "none";
}

/* =====================================================
   TIMER
===================================================== */
let timeLeft = 0;
let totalTime = 0;
let timerInterval = null;

/* =====================================================
   REVIEW MODE SETUP
===================================================== */
if(reviewMode){
  document.getElementById("submitBtn").style.display = "none";
  document.getElementById("timerBox").style.display = "none";
  document.getElementById("progressBar").style.display = "none";

  const saved = localStorage.getItem("review_answers");
  if(saved) answers = JSON.parse(saved);
}

/* =====================================================
   CHECK ALREADY ATTEMPTED
===================================================== */
async function checkAlreadyAttempted(){

  if(reviewMode) return false;

  const { data } = await supabaseClient
    .from("temp_results")
    .select("id")
    .eq("user_name", userName)
    .eq("level", level)
    .eq("mock_number", mockNumber);

  if(data && data.length > 0){
    location.replace("temp_result.html");
    return true;
  }
  return false;
}

/* =====================================================
   LOAD QUESTIONS
===================================================== */
async function loadQuestions(){

  if(!reviewMode){
    const locked = await checkAlreadyAttempted();
    if(locked) return;
  }

  const { data, error } = await supabaseClient
    .from("temp_questions")
    .select("*")
    .eq("level", level)
    .eq("mock_number", mockNumber)
    .order("id", { ascending:true });

  if(error){
    console.error(error);
    alert("Error loading questions");
    return;
  }

  questions = data || [];

  if(questions.length === 0){
    document.getElementById("questionBox").innerHTML =
      "<h3>No Questions Found</h3>";
    return;
  }

  /* timer start */
  if(!reviewMode){
    totalTime = questions.length * 45;
    timeLeft = totalTime;
    startTimer();
  }

  renderQuestion();
}

/* =====================================================
   TIMER START
===================================================== */
function startTimer(){

  timerInterval = setInterval(()=>{

    const m = Math.floor(timeLeft/60);
    const s = timeLeft%60;

    document.getElementById("timerBox").innerText =
      `‚è± ${m.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`;

    const percent = (timeLeft/totalTime)*100;
    document.getElementById("progressBar").style.width = percent+"%";

    if(timeLeft <= 0){
      clearInterval(timerInterval);
      submitExam();
    }

    timeLeft--;

  },1000);
}

/* =====================================================
   SAFE JSON PARSER
===================================================== */
function parseJSON(val){
  if(!val) return [];
  if(Array.isArray(val)) return val;
  try{ return JSON.parse(val); }
  catch{ return []; }
}

/* =====================================================
   RENDER QUESTION
===================================================== */
function renderQuestion(){

  const q = questions[currentIndex];

  document.getElementById("qCount").innerText =
    `Question ${currentIndex+1} / ${questions.length}`;

  const questionText =
    (lang==="en" && q.question_en) ? q.question_en : q.question_ml;

  document.getElementById("qText").innerText = questionText;

  const options =
    (lang==="en" && q.options_en)
    ? parseJSON(q.options_en)
    : parseJSON(q.options_ml);

  const optDiv = document.getElementById("options");
  optDiv.innerHTML = "";
  document.getElementById("explanationBox").innerHTML = "";

  options.forEach((opt,i)=>{

    const div = document.createElement("div");
    div.className = "option";
    div.innerText = opt;

    if(reviewMode){

      if(answers[currentIndex] === i){
        if(i === q.correct_index) div.classList.add("correct");
        else div.classList.add("wrong");
      }

      if(i === q.correct_index) div.classList.add("correct");

    }else{

      div.onclick = ()=>{
        answers[currentIndex] = i;
        renderQuestion();
      };

      if(answers[currentIndex] === i)
        div.classList.add("selected");
    }

    optDiv.appendChild(div);
  });

  if(reviewMode){
    const explanation =
      (lang==="en" && q.explanation_en)
      ? q.explanation_en
      : q.explanation_ml;

    document.getElementById("explanationBox").innerHTML =
      `<strong>Explanation:</strong><br>${explanation}`;
  }
}

/* =====================================================
   NAVIGATION
===================================================== */
function nextQ(){
  if(currentIndex < questions.length-1){
    currentIndex++;
    renderQuestion();
  }
}

function prevQ(){
  if(currentIndex > 0){
    currentIndex--;
    renderQuestion();
  }
}

/* =====================================================
   LANGUAGE
===================================================== */
function toggleLang(){
  if(level==="10th") return;
  lang = lang==="en" ? "ml" : "en";
  renderQuestion();
}

/* =====================================================
   SUBMIT EXAM (FIXED)
===================================================== */
async function submitExam(){

  if(examSubmitted) return;
  examSubmitted = true;

  clearInterval(timerInterval);

  let score = 0;
  questions.forEach((q,i)=>{
    if(answers[i] === q.correct_index) score++;
  });

  const timeUsed = totalTime - timeLeft;

  localStorage.setItem("review_answers", JSON.stringify(answers));

  const { error } = await supabaseClient
    .from("temp_results")
    .insert([{
      user_name: userName,
      level: level,
      mock_number: mockNumber,
      score: score,
      total: questions.length,
      time_used: timeUsed,
      answers_json: JSON.stringify(answers)
    }]);

  if(error){
    console.error("INSERT ERROR:", error);
    alert("Error saving result. See console.");
    examSubmitted = false;
    return;
  }

  location.replace("temp_result.html");
}

/* =====================================================
   EXIT
===================================================== */
function exitExam(){
  clearInterval(timerInterval);
  localStorage.removeItem("review_mode");
  location.replace("temp_dashboard.html");
}

/* =====================================================
   START
===================================================== */
loadQuestions();

</script>

</body>
</html>
